name: Flowai Release
run-name: Flowai Release by @${{ github.actor }}

on:
  workflow_dispatch:
    inputs:
      release_package_base:
        description: "Release Flowai Base"
        required: true
        type: boolean
        default: true
      release_package_main:
        description: "Release Flowai"
        required: true
        type: boolean
        default: true
      build_docker_base:
        description: "Build Docker Image for Flowai Base"
        required: true
        type: boolean
        default: true
      build_docker_main:
        description: "Build Docker Image for Flowai"
        required: true
        type: boolean
        default: true
      build_docker_ep:
        description: "Build Docker Image for Flowai with Entrypoint"
        required: false
        type: boolean
        default: true
      publish_to_pypi:
        description: "Publish packages to PyPI"
        required: false
        type: boolean
        default: false
      pre_release:
        description: "Pre-release"
        required: false
        type: boolean
        default: true
      create_release:
        description: "Whether to create a gh release"
        required: false
        type: boolean
        default: true


jobs:
  ci:
    if: ${{ github.event.inputs.release_package_base == 'true' || github.event.inputs.release_package_main == 'true' }}
    name: CI
    uses: ./.github/workflows/ci.yml
    with:
      python-versions: "['3.10', '3.11', '3.12']"
      frontend-tests-folder: "tests"
      release: true

  release-base:
    name: Release Flowai Base
    needs: [ci]
    if: inputs.release_package_base == true
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.check-version.outputs.version }}
      skipped: ${{ steps.check-version.outputs.skipped }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Setup Environment
        uses: ./.github/actions/setup-uv
      - name: Install the project
        run: uv sync --dev
      - name: Check Version
        id: check-version
        run: |
          version=$(uv tree | grep 'flowai-base' | awk '{print $3}' | sed 's/^v//')
          last_released_version=$(curl -s "https://pypi.org/pypi/flowai-base/json" | jq -r '.releases | keys | .[]' | sort -V | tail -n 1)
          if [ "$version" = "$last_released_version" ]; then
            echo "Version $version is already released. Skipping release."
            echo skipped=true >> $GITHUB_OUTPUT
            exit 0
          else
            echo version=$version >> $GITHUB_OUTPUT
            echo skipped=false >> $GITHUB_OUTPUT
          fi
      - name: Build project for distribution
        if: steps.check-version.outputs.skipped == 'false'
        run: make build base=true args="--wheel"
      - name: Test CLI
        if: steps.check-version.outputs.skipped == 'false'
        run: |
          # TODO: Unsure why the whl is not built in src/backend/base/dist
          mkdir src/backend/base/dist
          mv dist/*.whl src/backend/base/dist
          uv pip install src/backend/base/dist/*.whl
          uv run python -m flowai run --host 127.0.0.1 --port 7860 --backend-only &
          SERVER_PID=$!
          # Wait for the server to start
          timeout 120 bash -c 'until curl -f http://127.0.0.1:7860/api/v1/auto_login; do sleep 2; done' || (echo "Server did not start in time" && kill -9 $SERVER_PID 2>/dev/null && exit 1)
          # Terminate the server gracefully
          kill $SERVER_PID 2>/dev/null || true
          # Wait up to 30 seconds for graceful shutdown
          for i in {1..30}; do
            if ! kill -0 $SERVER_PID 2>/dev/null; then
              echo "Server terminated successfully after ${i} seconds"
              exit 0
            fi
            sleep 1
          done
          # Force kill if still running
          echo "Server did not terminate gracefully, forcing shutdown"
          kill -9 $SERVER_PID 2>/dev/null || true
          sleep 2
          if kill -0 $SERVER_PID 2>/dev/null; then
            echo "Failed to terminate the server even with SIGKILL"
            exit 1
          else
            echo "Server forcefully terminated"
          fi
      - name: Publish to PyPI
        if: steps.check-version.outputs.skipped == 'false' && inputs.publish_to_pypi == true
        env:
          UV_PUBLISH_TOKEN: ${{ secrets.PYPI_API_TOKEN }}
        run: |
          make publish base=true
      - name: Upload Artifact
        if: steps.check-version.outputs.skipped == 'false'
        uses: actions/upload-artifact@v4
        with:
          name: dist-base
          path: src/backend/base/dist

  release-main:
    name: Release Flowai Main
    if: inputs.release_package_main == true
    needs: [release-base]
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.check-version.outputs.version }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Setup Environment
        uses: ./.github/actions/setup-uv
      - name: Install the project
        run: uv sync --dev

      # If pre-release is true, we need to check if  ["a", "b", "rc", "dev", "post"] is in the version string
      # if the version string is incorrect, we need to exit the workflow
      - name: Check if pre-release
        if: inputs.pre_release == 'true'
        run: |
          version=$(uv tree | grep 'flowai' | grep -v 'flowai-base' | awk '{print $2}' | sed 's/^v//')
          if [[ "${version}" =~ ^([0-9]+\.)?([0-9]+\.)?[0-9]+((a|b|rc|dev|post)([0-9]+))$ ]]; then
            echo "Pre-release version detected. Continuing with the release."
          else
            echo "Invalid pre-release version detected. Exiting the workflow."
            exit 1
          fi
      - name: Check Version
        id: check-version
        run: |
          version=$(uv tree | grep 'flowai' | grep -v 'flowai-base' | awk '{print $2}' | sed 's/^v//')
          last_released_version=$(curl -s "https://pypi.org/pypi/flowai/json" | jq -r '.releases | keys | .[]' | sort -V | tail -n 1)
          if [ "$version" = "$last_released_version" ]; then
            echo "Version $version is already released. Skipping release."
            exit 1
          else
            echo version=$version >> $GITHUB_OUTPUT
          fi
      - name: Wait for PyPI Propagation
        if: needs.release-base.outputs.skipped == 'false'
        run: sleep 300 # wait for 5 minutes to ensure PyPI propagation

      - name: Build project for distribution
        run: make build main=true args="--no-sources --wheel"
      - name: Test CLI
        run: |
          uv pip install dist/*.whl
          uv run python -m flowai run --host 127.0.0.1 --port 7860 --backend-only &
          SERVER_PID=$!
          # Wait for the server to start
          timeout 120 bash -c 'until curl -f http://127.0.0.1:7860/health_check; do sleep 2; done' || (echo "Server did not start in time" && kill -9 $SERVER_PID 2>/dev/null && exit 1)
          # Terminate the server gracefully
          kill $SERVER_PID 2>/dev/null || true
          # Wait up to 30 seconds for graceful shutdown
          for i in {1..30}; do
            if ! kill -0 $SERVER_PID 2>/dev/null; then
              echo "Server terminated successfully after ${i} seconds"
              exit 0
            fi
            sleep 1
          done
          # Force kill if still running
          echo "Server did not terminate gracefully, forcing shutdown"
          kill -9 $SERVER_PID 2>/dev/null || true
          sleep 2
          if kill -0 $SERVER_PID 2>/dev/null; then
            echo "Failed to terminate the server even with SIGKILL"
            exit 1
          else
            echo "Server forcefully terminated"
          fi
      - name: Publish to PyPI
        if: inputs.publish_to_pypi == true
        env:
          UV_PUBLISH_TOKEN: ${{ secrets.PYPI_API_TOKEN }}
        run: |
          make publish main=true
      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: dist-main
          path: dist

  docker_build_base:
    name: Build Docker Image for Flowai Base (Local Packages)
    if: inputs.build_docker_base == true
    needs: [release-base]
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Download base artifacts
        uses: actions/download-artifact@v4
        with:
          name: dist-base
          path: dist
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}
      
      - name: Build and push base image
        uses: docker/build-push-action@v6
        with:
          context: .
          push: true
          file: ./docker/build_and_push_base_local.Dockerfile
          tags: |
            digitranslab/flowai:base-${{ needs.release-base.outputs.version }}
            digitranslab/flowai:base-latest
          platforms: linux/amd64,linux/arm64
          cache-from: type=gha
          cache-to: type=gha,mode=max

  docker_build_main:
    name: Build Docker Image for Flowai (Local Packages)
    if: inputs.build_docker_main == true
    needs: [release-base, release-main]
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Download base artifacts
        uses: actions/download-artifact@v4
        with:
          name: dist-base
          path: dist
      
      - name: Download main artifacts
        uses: actions/download-artifact@v4
        with:
          name: dist-main
          path: dist
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}
      
      - name: Build and push main image
        uses: docker/build-push-action@v6
        with:
          context: .
          push: true
          file: ./docker/build_and_push_local.Dockerfile
          tags: |
            digitranslab/flowai:${{ needs.release-main.outputs.version }}
            ${{ inputs.pre_release == false && 'digitranslab/flowai:latest' || '' }}
          platforms: linux/amd64,linux/arm64
          cache-from: type=gha
          cache-to: type=gha,mode=max

  docker_build_main_ep:
    name: Build Docker Image for Flowai with Entrypoint (Local Packages)
    if: inputs.build_docker_ep == true
    needs: [release-base, release-main]
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Download base artifacts
        uses: actions/download-artifact@v4
        with:
          name: dist-base
          path: dist
      
      - name: Download main artifacts
        uses: actions/download-artifact@v4
        with:
          name: dist-main
          path: dist
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}
      
      - name: Build and push entrypoint image
        uses: docker/build-push-action@v6
        with:
          context: .
          push: true
          file: ./docker/build_and_push_ep_local.Dockerfile
          tags: |
            digitranslab/flowai-ep:${{ needs.release-main.outputs.version }}
            digitranslab/flowai-ep:latest
          platforms: linux/amd64,linux/arm64
          cache-from: type=gha
          cache-to: type=gha,mode=max

  create_release:
    name: Create Release
    runs-on: ubuntu-latest
    needs: release-main
    steps:
      - uses: actions/download-artifact@v4
        with:
          name: dist-main
          path: dist
      - name: Create Release
        uses: ncipollo/release-action@v1
        with:
          artifacts: "dist/*"
          token: ${{ secrets.GITHUB_TOKEN }}
          draft: false
          generateReleaseNotes: true
          prerelease: ${{ inputs.pre_release }}
          tag: ${{ needs.release-main.outputs.version }}
          commit: ${{ github.ref }}
